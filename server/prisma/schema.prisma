generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // optional for social logins
  googleId  String?  @unique // Google OAuth ID
  name      String?
  avatarUrl String?
  coverUrl  String?
  bio       String?
  city      String?
  interests Json? // stored as JSON array in MySQL
  groups    GroupMember[]
  eventsAttending EventAttendee[]
  ownedGroups Group[] @relation("OwnedGroups")
  comments  Comment[]
  passwordResetTokens PasswordResetToken[]
  followers Follow[] @relation("Followers")
  following Follow[] @relation("Following")
  notifications Notification[]
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  city        String
  coverImage  String?
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], name: "OwnedGroups")
  members     GroupMember[]
  events      Event[]
}

model GroupMember {
  userId  String
  groupId String
  role    String // "member" | "admin"
  joinedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  group Group @relation(fields: [groupId], references: [id])

  @@id([userId, groupId])
}

model Event {
  id          String   @id @default(cuid())
  groupId     String
  title       String
  description String?
  startsAt    DateTime
  endsAt      DateTime?
  venue       String?
  address     String?
  city        String
  capacity    Int?
  price       Float?   @default(0) // price in dollars, 0 means free
  imageUrl    String?
  tags        Json?
  attendees   EventAttendee[]
  comments    Comment[]
  group       Group    @relation(fields: [groupId], references: [id])
}

model EventAttendee {
  userId    String
  eventId   String
  status    String // "going" | "interested" | "cancelled"

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@id([userId, eventId])
}

model Comment {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  content   String
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  used       Boolean  @default(false)
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
}

model Follow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Following", fields: [followerId], references: [id])
  following   User     @relation("Followers", fields: [followingId], references: [id])

  @@id([followerId, followingId])
  @@index([followingId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "follow" | "event_rsvp" | "comment" | "event_reminder"
  message   String
  data      Json?    // Additional data like eventId, followerId, etc.
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  
  @@index([userId, read])
}
